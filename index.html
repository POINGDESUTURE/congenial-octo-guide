<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QCM M√©decine</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .correct { background-color: #d4edda !important; border-color: #c3e6cb !important; }
        .incorrect { background-color: #f8d7da !important; border-color: #f5c6cb !important; }
        .missed { background-color: #fff3cd !important; border-color: #ffeaa7 !important; }
        .qcm-card { margin-bottom: 20px; }
        .option-label { cursor: pointer; padding: 10px; border-radius: 5px; transition: all 0.2s; }
        .option-label:hover { background-color: #e9ecef; }
        .hidden { display: none; }
        .loading { text-align: center; padding: 40px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">üè• QCM M√©decine</h1>

        <!-- Loading -->
        <div id="loadingScreen" class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-3">Chargement des QCM...</p>
        </div>

        <!-- √âcran d'accueil -->
        <div id="homeScreen" class="hidden">
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title">Choisissez une mati√®re</h3>
                    <div id="subjectsList" class="list-group"></div>
                </div>
            </div>
        </div>

        <!-- √âcran des chapitres -->
        <div id="chapterScreen" class="hidden">
            <button class="btn btn-secondary mb-3" onclick="backToHome()">‚Üê Retour</button>
            <div class="card">
                <div class="card-body">
                    <h3 id="currentSubjectTitle"></h3>
                    <div id="chaptersList" class="list-group"></div>
                </div>
            </div>
        </div>

        <!-- √âcran de session -->
        <div id="qcmScreen" class="hidden">
            <button class="btn btn-secondary mb-3" onclick="backToChapters()">‚Üê Retour</button>
            <div class="card mb-3">
                <div class="card-body">
                    <h4 id="sessionChapterTitle"></h4>
                    <div class="mb-3">
                        <label class="form-label">Nombre de questions par session</label>
                        <input type="number" id="sessionSize" class="form-control" value="10" min="1">
                    </div>
                    <button class="btn btn-primary btn-lg w-100" onclick="startSession()">D√©marrer la session</button>
                </div>
            </div>
            <div class="alert alert-info">
                <strong><span id="chapterQcmCount">0</span> QCM disponibles</strong> dans ce chapitre
            </div>
        </div>

        <!-- √âcran de questions -->
        <div id="sessionScreen" class="hidden">
            <div class="mb-3">
                <span class="badge bg-info">Question <span id="currentQuestionNum">1</span> / <span id="totalQuestions">10</span></span>
            </div>
            <div class="card qcm-card">
                <div class="card-body">
                    <h5 id="questionText"></h5>
                    <div id="optionsContainer"></div>
                    <button class="btn btn-primary mt-3" onclick="nextQuestion()">Question suivante</button>
                </div>
            </div>
        </div>

        <!-- √âcran de correction -->
        <div id="correctionScreen" class="hidden">
            <div class="card">
                <div class="card-body">
                    <h3>R√©sultats de la session</h3>
                    <p class="lead">Score: <span id="score"></span></p>
                    <div id="correctionDetails"></div>
                    <button class="btn btn-success me-2" onclick="downloadMissedAnswers()">üì• T√©l√©charger les r√©ponses manqu√©es</button>
                    <button class="btn btn-primary" onclick="backToQCMScreen()">Nouvelle session</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let data = {};
        let currentSubject = '';
        let currentChapter = '';
        let currentSession = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let missedAnswers = [];

        async function loadAllQCM() {
            try {
                const configResponse = await fetch('QCM/config.json');
                const subjects = await configResponse.json();

                for (const subject in subjects) {
                    data[subject] = {};
                    
                    for (const chapterFile of subjects[subject]) {
                        try {
                            const response = await fetch(`QCM/${subject}/${chapterFile}`);
                            const text = await response.text();
                            const qcms = parseQCMFile(text);
                            
                            const chapterName = chapterFile.replace('.txt', '').replace(/_/g, ' ');
                            data[subject][chapterName] = qcms;
                            
                            console.log(`‚úÖ ${subject} - ${chapterName}: ${qcms.length} QCM charg√©s`);
                        } catch (error) {
                            console.error(`‚ùå Erreur ${subject}/${chapterFile}:`, error);
                        }
                    }
                }

                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('homeScreen').classList.remove('hidden');
                displaySubjects();
            } catch (error) {
                document.getElementById('loadingScreen').innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Erreur de chargement</h4>
                        <p>Impossible de charger le fichier de configuration.</p>
                        <p class="small">Assurez-vous que le fichier <code>QCM/config.json</code> existe.</p>
                    </div>
                `;
                console.error('Erreur:', error);
            }
        }

        function parseQCMFile(content) {
            const qcms = [];
            
            content = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            let lines = content.split('\n');
            const startIdx = lines.findIndex(line => line.includes('==='));
            if (startIdx !== -1) {
                const headerEnd = lines.findIndex((line, idx) => idx > startIdx && line.trim().startsWith('='));
                if (headerEnd !== -1) {
                    lines = lines.slice(headerEnd + 1);
                }
            }
            
            content = lines.join('\n');
            const blocks = content.split(/\n\s*\n+/).filter(block => block.trim());
            
            console.log(`üìä ${blocks.length} blocs d√©tect√©s`);
            
            blocks.forEach((block, blockIdx) => {
                const lines = block.trim().split('\n').map(line => line.trim()).filter(line => line);
                
                if (lines.length < 6) {
                    console.warn(`‚ö†Ô∏è Bloc ${blockIdx + 1} ignor√© (${lines.length} lignes)`);
                    return;
                }
                
                const question = lines[0];
                const options = [];
                
                for (let i = 1; i < lines.length && options.length < 5; i++) {
                    const line = lines[i];
                    const match = line.match(/^(\$?)([A-E])\.?\s*(.+)$/i);
                    
                    if (match) {
                        const isCorrect = match[1] === '$';
                        const letter = match[2].toUpperCase();
                        const text = match[3].trim();
                        
                        const expectedLetter = String.fromCharCode(65 + options.length);
                        if (letter === expectedLetter) {
                            options.push({ text, isCorrect });
                        }
                    }
                }
                
                if (options.length === 5) {
                    qcms.push({ question, options });
                } else {
                    console.warn(`‚ö†Ô∏è Bloc ${blockIdx + 1} ignor√©: ${options.length}/5 options`);
                }
            });
            
            return qcms;
        }

        function displaySubjects() {
            const list = document.getElementById('subjectsList');
            list.innerHTML = '';
            
            for (let subject in data) {
                const totalQCMs = Object.values(data[subject]).reduce((sum, qcms) => sum + qcms.length, 0);
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                item.innerHTML = `${subject} <span class="badge bg-primary rounded-pill">${totalQCMs} QCM</span>`;
                item.onclick = (e) => {
                    e.preventDefault();
                    openSubject(subject);
                };
                list.appendChild(item);
            }
        }

        function openSubject(subject) {
            currentSubject = subject;
            document.getElementById('homeScreen').classList.add('hidden');
            document.getElementById('chapterScreen').classList.remove('hidden');
            document.getElementById('currentSubjectTitle').textContent = subject;
            displayChapters();
        }

        function backToHome() {
            document.getElementById('chapterScreen').classList.add('hidden');
            document.getElementById('homeScreen').classList.remove('hidden');
        }

        function displayChapters() {
            const list = document.getElementById('chaptersList');
            list.innerHTML = '';
            
            for (let chapter in data[currentSubject]) {
                const qcmCount = data[currentSubject][chapter].length;
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                item.innerHTML = `${chapter} <span class="badge bg-secondary rounded-pill">${qcmCount} QCM</span>`;
                item.onclick = (e) => {
                    e.preventDefault();
                    openChapter(chapter);
                };
                list.appendChild(item);
            }
        }

        function openChapter(chapter) {
            currentChapter = chapter;
            const qcmCount = data[currentSubject][currentChapter].length;
            
            document.getElementById('chapterScreen').classList.add('hidden');
            document.getElementById('qcmScreen').classList.remove('hidden');
            document.getElementById('sessionChapterTitle').textContent = `${currentSubject} - ${currentChapter}`;
            document.getElementById('chapterQcmCount').textContent = qcmCount;
            document.getElementById('sessionSize').value = Math.min(10, qcmCount);
            document.getElementById('sessionSize').max = qcmCount;
        }

        function backToChapters() {
            document.getElementById('qcmScreen').classList.add('hidden');
            document.getElementById('sessionScreen').classList.add('hidden');
            document.getElementById('chapterScreen').classList.remove('hidden');
        }

        function backToQCMScreen() {
            document.getElementById('correctionScreen').classList.add('hidden');
            document.getElementById('qcmScreen').classList.remove('hidden');
        }

        function startSession() {
            const qcms = data[currentSubject][currentChapter];
            if (qcms.length === 0) {
                alert('Aucun QCM disponible');
                return;
            }

            const sessionSize = Math.min(parseInt(document.getElementById('sessionSize').value), qcms.length);
            const shuffled = [...qcms].sort(() => Math.random() - 0.5);
            currentSession = shuffled.slice(0, sessionSize);
            currentQuestionIndex = 0;
            userAnswers = [];
            missedAnswers = [];

            document.getElementById('qcmScreen').classList.add('hidden');
            document.getElementById('sessionScreen').classList.remove('hidden');
            document.getElementById('totalQuestions').textContent = currentSession.length;
            
            displayQuestion();
        }

        function displayQuestion() {
            const qcm = currentSession[currentQuestionIndex];
            document.getElementById('currentQuestionNum').textContent = currentQuestionIndex + 1;
            document.getElementById('questionText').textContent = qcm.question;

            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';

            qcm.options.forEach((option, idx) => {
                const letter = String.fromCharCode(65 + idx);
                const div = document.createElement('div');
                div.className = 'form-check mb-2';
                div.innerHTML = `
                    <input class="form-check-input" type="checkbox" id="option${idx}" value="${idx}">
                    <label class="form-check-label option-label w-100" for="option${idx}">
                        ${letter}. ${option.text}
                    </label>
                `;
                container.appendChild(div);
            });
        }

        function nextQuestion() {
            const qcm = currentSession[currentQuestionIndex];
            const selectedOptions = [];
            
            qcm.options.forEach((option, idx) => {
                const checkbox = document.getElementById(`option${idx}`);
                if (checkbox.checked) {
                    selectedOptions.push(idx);
                }
            });

            userAnswers.push(selectedOptions);

            qcm.options.forEach((option, idx) => {
                if (option.isCorrect && !selectedOptions.includes(idx)) {
                    const letter = String.fromCharCode(65 + idx);
                    missedAnswers.push({
                        question: qcm.question,
                        answer: `${letter}. ${option.text}`
                    });
                }
            });

            currentQuestionIndex++;

            if (currentQuestionIndex < currentSession.length) {
                displayQuestion();
            } else {
                showCorrection();
            }
        }

        function showCorrection() {
            document.getElementById('sessionScreen').classList.add('hidden');
            document.getElementById('correctionScreen').classList.remove('hidden');

            let correctCount = 0;
            let totalCorrect = 0;
            let totalUserCorrect = 0;

            const details = document.getElementById('correctionDetails');
            details.innerHTML = '';

            currentSession.forEach((qcm, qIdx) => {
                const userSelection = userAnswers[qIdx];
                const card = document.createElement('div');
                card.className = 'card mb-3';
                
                let optionsHtml = '';
                let questionCorrect = true;

                qcm.options.forEach((option, oIdx) => {
                    const letter = String.fromCharCode(65 + oIdx);
                    const userSelected = userSelection.includes(oIdx);
                    const isCorrect = option.isCorrect;

                    let className = 'list-group-item';
                    if (isCorrect && userSelected) {
                        className += ' correct';
                        totalCorrect++;
                        totalUserCorrect++;
                    } else if (isCorrect && !userSelected) {
                        className += ' missed';
                        totalCorrect++;
                        questionCorrect = false;
                    } else if (!isCorrect && userSelected) {
                        className += ' incorrect';
                        questionCorrect = false;
                    }

                    const icon = isCorrect ? '‚úì' : (userSelected ? '‚úó' : '');
                    optionsHtml += `<li class="${className}">${icon} ${letter}. ${option.text}</li>`;
                });

                if (questionCorrect) correctCount++;

                card.innerHTML = `
                    <div class="card-body">
                        <h6>Question ${qIdx + 1}</h6>
                        <p>${qcm.question}</p>
                        <ul class="list-group">${optionsHtml}</ul>
                    </div>
                `;
                details.appendChild(card);
            });

            document.getElementById('score').textContent = `${correctCount}/${currentSession.length} questions parfaites - ${totalUserCorrect}/${totalCorrect} bonnes r√©ponses coch√©es`;
        }

        function downloadMissedAnswers() {
            if (missedAnswers.length === 0) {
                alert('Aucune r√©ponse manqu√©e ! Parfait ! üéâ');
                return;
            }

            let content = '=== R√âPONSES MANQU√âES - FLASHCARDS ===\n\n';
            missedAnswers.forEach((item, idx) => {
                content += `${idx + 1}. ${item.question}\n`;
                content += `   ‚Üí ${item.answer}\n\n`;
            });

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flashcards_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        loadAllQCM();
    </script>
</body>
</html>